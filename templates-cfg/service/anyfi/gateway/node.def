tag:
priority: 999
type: txt
help: Anyfi Gateway

end:
     # Validate configuration and generate conffile
     if [ ${COMMIT_ACTION} != DELETE ]; then
         if [ -z "$VAR(controller/@)" ]; then
            echo "Error configuring anyfi gateway: must specify controller."
            exit 1
         fi

         sudo /opt/vyatta/sbin/vyatta-anyfi-gateway.pl --instance=$VAR(@) \
                 --config=/etc/anyfi-gateway-$VAR(@).conf || exit 1 
     fi

     # Stop the old daemon
     if [ ${COMMIT_ACTION} == ACTIVE ] || [ ${COMMIT_ACTION} == DELETE ]; then
         echo -n "Stopping anyfi gateway:"
         sudo /opt/vyatta/sbin/vyatta-anyfi-stop-daemon /var/run/anyfi-gateway-$VAR(@).pid && \
             echo " anyfi-gateway." || echo " [E anyfi-gateway]."
     fi

     # Start a new daemon
     if [ ${COMMIT_ACTION} != DELETE ]; then
         if /bin/cli-shell-api exists service anyfi gateway $VAR(@) port-range; then
             port_range=`/bin/cli-shell-api returnValue service anyfi gateway $VAR(@) port-range`
             start_port="-p `echo $port_range | awk -F '-' '{print $1}'`"
         else
             start_port=""
         fi

         echo -n "Starting anyfi gateway:"
         sudo /usr/sbin/anyfi-gateway --accept-license -C $VAR(controller/@) $start_port \
                 -B -P /var/run/anyfi-gateway-$VAR(@).pid /etc/anyfi-gateway-$VAR(@).conf || exit 1
         echo " anyfi-gateway."
     fi

